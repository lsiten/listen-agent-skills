# SigNoz 查询优化指南

本文档详细说明如何优化 SigNoz 查询，解决查询查不到数据的问题。

## 常见问题及解决方案

### 1. 查询结果 rows 为 null

**问题现象**：查询返回结果中 `rows` 字段为 `null`，没有数据。

**常见原因**：

#### 1.1 字段歧义（最常见）

**症状**：查询结果中包含警告信息，如：
```json
{
  "warnings": [
    "key service.name is ambiguous, found 2 different combinations of field context and data type: [name=service.name,context=resource,type=string name=service.name,context=attribute,type=string]"
  ],
  "rows": null
}
```

**解决方案**（必须同时使用两种方法）：

1. **在 filter.expression 中使用完整前缀**（必须）：
   ```json
   {
     "filter": {
       "expression": "resource.service.name IN ('cs.web.camscanner-toc') AND attribute.user.id = 1734170267"
     }
   }
   ```

2. **在 selectFields 中明确指定 fieldContext 和 fieldDataType**（必须）：
   ```json
   {
     "selectFields": [
       {
         "name": "service.name",
         "fieldContext": "resource",
         "fieldDataType": "string",
         "signal": "logs"
       },
       {
         "name": "user.id",
         "fieldContext": "attributes",
         "fieldDataType": "int64",
         "signal": "logs"
       }
     ]
   }
   ```

**常见歧义字段处理**：

| 字段 | filter.expression 格式 | selectFields 格式 |
|------|----------------------|------------------|
| `service.name` | `resource.service.name` | `{"fieldContext": "resource", "fieldDataType": "string"}` |
| `user.id` | `attribute.user.id` | `{"fieldContext": "attributes", "fieldDataType": "int64"}` |
| `user.client_id` | `attribute.user.client_id` | `{"fieldContext": "attributes", "fieldDataType": "string"}` |

#### 1.2 时间戳单位错误

**症状**：查询无结果，但没有警告信息。

**原因**：不同工具使用不同的时间戳单位：
- `signoz_list_services` 和 `signoz_get_service_top_operations`：**纳秒**（毫秒 × 1,000,000）
- 其他工具（如 `signoz_execute_builder_query`）：**毫秒**

**解决方案**：
- **推荐**：优先使用 `timeRange` 参数（如 `"1h"`, `"4h"`, `"24h"`），避免时间戳单位错误
- 如果必须使用时间戳，确保单位正确

#### 1.3 时间范围问题

**症状**：查询无结果，时间范围可能不正确。

**常见问题**：
- 时间范围在未来（查询时间 > 当前时间）
- 时间范围过窄（小于 2 小时）
- 时间范围过长（超过 3 天）
- 时间范围在很久以前（超过 30 天，数据可能已过期）

**解决方案**：
1. **检查时间范围**：确保查询时间范围合理
2. **自动调整**：
   - 如果时间在未来：调整为最近 24 小时
   - 如果时间范围过窄（< 2 小时）：自动扩展为 ±2 小时
   - 如果时间范围过长（> 3 天）：自动截断为 3 天
3. **验证时间戳**：确保时间戳计算正确（基于工单中的实际时间，不是当前时间）

#### 1.4 服务名称不匹配

**症状**：查询无结果，服务名称可能不正确。

**原因**：代码中的服务名可能与运行时不同。

**解决方案**：
1. **必须首先执行** `signoz_list_services` 获取实际服务列表
2. 使用 `timeRange` 参数（推荐）或确保时间戳单位正确（纳秒）
3. 根据实际服务名称更新查询条件

#### 1.5 查询条件过于严格

**症状**：查询无结果，但数据可能确实存在。

**原因**：过滤条件太严格，导致查不到数据。

**解决方案**：
1. **逐步放宽条件**：
   - 先查询服务 + 时间范围（不限定用户）
   - 如果有数据，再逐步添加过滤条件
2. **使用 OR 条件**：如果多个条件可能匹配，使用 OR 而不是 AND
3. **移除非必要条件**：先移除一些非关键过滤条件，确认数据存在后再添加

### 2. 查询结果为空（rows 为空数组）

**问题现象**：查询返回结果中 `rows` 为空数组 `[]`，没有数据。

**可能原因**：
1. 该时间范围内确实没有数据
2. 过滤条件不匹配任何数据
3. 服务名称不正确
4. 时间范围不正确

**解决方案**：

#### 2.1 验证服务名称（必须首先执行）

⚠️ **关键**：`signoz_list_services` 返回空数组时，必须使用更长的时间范围。

**问题**：如果使用较短的时间范围（如 4h），可能该时间段内服务没有数据，导致返回空数组。

**解决方案**：
```json
{
  "tool": "signoz_list_services",
  "params": {
    "timeRange": "24h"  // 或 "7d"，使用更长的时间范围
  }
}
```

**重要提示**：
- 默认时间范围是 6 小时，如果该时间段内服务没有数据，会返回空数组
- 必须使用更长的时间范围（24h 或 7d）来确认服务名称
- 如果 24h 仍无结果，尝试 7d

#### 2.2 检查 rowsScanned 字段

**问题现象**：查询结果中 `rowsScanned: 0`，说明该时间段确实没有该服务的数据。

**可能原因**：
1. 服务名称不匹配（实际运行时可能使用不同的服务名称）
2. 该时间段服务确实没有产生日志
3. 日志可能存储在其他服务名称下

**解决方案**：
1. **首先确认服务名称**：使用 `signoz_list_services` 和更长的时间范围（24h 或 7d）
2. **如果服务名称正确但 rowsScanned 为 0**：
   - 扩展时间范围（从 ±2 小时扩展到 ±24 小时或 ±7 天）
   - 切换到其他时间优先级（明确说明的发生时间 → 邮件最早时间 → 最近1天 → 其他时间点）
   - 查询不限定用户ID的服务日志，确认服务是否有数据
3. **如果服务名称不正确**：
   - 根据 `signoz_list_services` 的结果更新服务名称
   - 重新执行查询

#### 2.3 逐步放宽查询条件

#### 2.2 逐步放宽查询条件

**策略 1：先查询服务 + 时间范围**
```json
{
  "filter": {
    "expression": "resource.service.name IN ('cs.web.camscanner-toc')"
  }
}
```

**策略 2：如果策略 1 有数据，再添加用户条件**
```json
{
  "filter": {
    "expression": "resource.service.name IN ('cs.web.camscanner-toc') AND attribute.user.id = 1734170267"
  }
}
```

**策略 3：如果策略 2 无数据，尝试查询错误日志**
```json
{
  "filter": {
    "expression": "resource.service.name IN ('cs.web.camscanner-toc') AND severity_text IN ('error', 'Error', 'ERROR', 'fatal', 'Fatal', 'FATAL')"
  }
}
```

#### 2.3 扩展时间范围

如果当前时间范围无数据，尝试：
- 扩展时间范围（从 ±2 小时扩展到 ±4 小时或 ±24 小时）
- 切换到其他时间优先级（明确说明的发生时间 → 邮件最早时间 → 最近1天 → 其他时间点）

#### 2.4 检查字段值

使用 `signoz_get_logs_field_values` 检查字段的实际值：
```json
{
  "tool": "signoz_get_logs_field_values",
  "params": {
    "field": "user.id",
    "timeRange": "24h"
  }
}
```

### 3. 查询超时

**问题现象**：查询请求超时，没有返回结果。

**原因**：
- 时间范围过大
- 查询条件过于复杂
- 数据量过大

**解决方案**：
1. **缩短时间范围**：将时间范围缩短为原来的一半
2. **简化查询条件**：移除不必要的过滤条件
3. **使用 limit**：限制返回记录数（默认 100，最大建议 1000）
4. **自动重试**：如果超时，自动优化时间区间长度（缩短为原来的一半），继续自动重试，最多重试 3 次

## 查询优化策略

### 策略 1：渐进式查询

**原则**：从宽泛到精确，逐步缩小范围。

**步骤**：
1. **第一步**：查询服务 + 时间范围（最宽泛）
2. **第二步**：如果第一步有数据，添加用户/设备条件
3. **第三步**：如果第二步有数据，添加错误级别条件
4. **第四步**：如果第三步有数据，添加接口路径条件

### 策略 2：多时间优先级查询

**原则**：按时间优先级依次查询，找到数据后提前终止。

**优先级**（从高到低）：
1. **明确说明的发生时间前后 2 小时**（最高优先级）
2. **邮件中最早发送时间前后 2 小时**（次优先级）
3. **最近 1 天时间**（第三优先级）
4. **工单中其他提到的时间点当天**（最低优先级）

**切换条件**：
- 当前时间区间内**所有查询都执行完毕**，且**所有查询结果都无法定位到问题**（无数据或数据不相关），才切换到下一个时间优先级
- 如果当前时间区间内**任意一个查询**有数据并且**相关数据能够定位到问题**，**不再查询**后续时间优先级

### 策略 3：迭代式查询

**原则**：根据查询结果动态调整查询策略。

**流程**：
1. **初始查询**：基于工单中的基础信息（服务名、时间范围、关键词等）
2. **结果分析**：分析查询结果，提取关键信息（错误类型、接口路径、设备信息、时间模式等）
3. **判断是否定位到问题**：
   - 如果能够定位到问题原因，停止查询
   - 如果无法定位，继续下一步
4. **生成补充查询**：基于分析结果，生成新的查询思路
5. **迭代深入**：重复步骤 2-4，逐步深入，直到定位到问题原因

### 策略 4：容错查询

**原则**：查询失败时自动尝试替代方案。

**容错机制**：
1. **字段歧义容错**：检测到字段歧义警告时，自动修复（添加完整前缀和 fieldContext）
2. **时间范围容错**：查询无结果时，自动扩展时间范围
3. **服务名称容错**：查询无结果时，自动执行 `list_services` 确认服务名称
4. **查询条件容错**：查询无结果时，逐步放宽查询条件

## 查询诊断检查清单

在执行查询前，检查以下项目：

### 1. 时间范围检查
- [ ] 时间范围是否合理（不是未来时间）
- [ ] 时间范围是否过窄（< 2 小时，应扩展为 ±2 小时）
- [ ] 时间范围是否过长（> 3 天，应截断为 3 天）
- [ ] 时间戳单位是否正确（纳秒 vs 毫秒）
- [ ] 是否优先使用 `timeRange` 参数

### 3. 字段歧义检查
- [ ] 是否在 `filter.expression` 中使用了完整前缀（`resource.` 或 `attribute.`）
- [ ] 是否在 `selectFields` 中明确指定了 `fieldContext` 和 `fieldDataType`
- [ ] 是否检查了查询结果中的 `warnings` 字段

### 4. 查询条件检查
- [ ] 查询条件是否过于严格（可以先放宽条件验证数据是否存在）
- [ ] 是否使用了正确的字段名（`user.id` 而不是 `user_id`）
- [ ] 字段值类型是否正确（`user.id` 是 int64，不需要引号）

### 5. 查询结果检查
- [ ] 是否检查了 `rows` 字段（`null` vs `[]`）
- [ ] 是否检查了 `warnings` 字段（字段歧义警告）
- [ ] 如果 `rows` 为 `null`，是否修复了字段歧义问题
- [ ] 如果 `rows` 为 `[]`，是否尝试了放宽查询条件或扩展时间范围

## 特殊场景处理

### 场景1：signoz_list_services 返回空数组

**问题**：`signoz_list_services` 使用默认的 6 小时时间范围，如果该时间段内服务没有数据，会返回空数组。

**解决方案**：
1. **使用更长的时间范围**：
   ```json
   {
     "tool": "signoz_list_services",
     "params": {
       "timeRange": "24h"  // 或 "7d"
     }
   }
   ```
2. **如果 24h 仍无结果，尝试 7d 或 30d**
3. **检查时间范围是否合理**：确保时间范围不是未来时间

### 场景2：rowsScanned 为 0

**问题**：查询结果中 `rowsScanned: 0`，说明该时间段确实没有该服务的数据。

**诊断步骤**：
1. **确认服务名称**：使用 `signoz_list_services` 和更长的时间范围（24h 或 7d）确认服务名称
2. **扩展时间范围**：如果服务名称正确，尝试扩展时间范围（从 ±2 小时扩展到 ±24 小时）
3. **切换到其他时间优先级**：如果当前时间范围无数据，切换到下一个时间优先级
4. **查询不限定用户的服务日志**：先确认服务是否有数据，再逐步添加用户ID过滤条件

### 场景3：字段歧义已修复但 rows 仍为 null

**问题**：已经修复字段歧义（使用完整前缀和 fieldContext），但 rows 仍为 null。

**可能原因**：
1. 还有其他字段存在歧义，需要检查 warnings 字段
2. 查询语法错误（如字段名拼写错误、值类型错误等）
3. 服务名称不正确

**解决方案**：
1. **检查 warnings 字段**：查看是否还有其他字段歧义警告
2. **验证字段名**：确保字段名正确（如 `user.id` 不是 `user_id`）
3. **验证字段值类型**：确保字段值类型正确（如 `user.id` 是 int64，不需要引号）
4. **确认服务名称**：使用 `signoz_list_services` 确认服务名称

## 最佳实践

## 最佳实践

1. **必须首先执行 list_services**：使用更长的时间范围（24h 或 7d）确认服务名称
2. **优先使用 Query Builder v5**：`signoz_execute_builder_query` 更灵活，支持复杂过滤条件
3. **优先使用 timeRange 参数**：避免时间戳单位错误
4. **处理字段歧义**：同时使用完整前缀和 fieldContext
5. **渐进式查询**：从宽泛到精确，逐步缩小范围
6. **迭代式查询**：根据查询结果动态调整查询策略
7. **容错机制**：查询失败时自动尝试替代方案
8. **验证结果**：检查 `rows`、`rowsScanned` 和 `warnings` 字段，确保查询成功
9. **检查 rowsScanned**：如果 `rowsScanned: 0`，说明该时间段确实没有数据，需要扩展时间范围或切换时间优先级

## 调试技巧

1. **查看查询结果中的 warnings**：字段歧义警告会在这里显示
2. **使用 get_logs_field_values**：检查字段的实际值
3. **逐步放宽条件**：先查询服务 + 时间范围，再逐步添加条件
4. **对比不同时间范围**：如果当前时间范围无数据，尝试其他时间范围
5. **检查服务列表**：使用 `list_services` 确认服务名称是否正确
